<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - EV Battery Swap System</title>
    <script>
        // Kiểm tra authentication NGAY LẬP TỨC - trước khi load bất kỳ thứ gì
        (function() {
            // Block toàn bộ HTML ngay lập tức
            if (document.documentElement) {
                document.documentElement.style.display = 'none';
            }
            if (document.body) {
                document.body.style.display = 'none';
            }
            
            // Kiểm tra token
            const adminToken = localStorage.getItem('adminToken');
            if (!adminToken || adminToken.trim() === '') {
                // Redirect NGAY - không cho xem bất kỳ nội dung nào
                window.location.replace('admin-login.html');
                // Force redirect nếu replace không work
                setTimeout(function() {
                    window.location.href = 'admin-login.html';
                }, 100);
                return;
            }
            
            // Nếu có token, cho phép hiển thị (sẽ được admin.js kiểm tra lại)
            if (document.documentElement) {
                document.documentElement.style.display = '';
            }
        })();
    </script>
    <style>
        /* Ẩn toàn bộ trang cho đến khi đã xác thực */
        html, body { 
            display: none !important; 
            visibility: hidden !important;
        }
        html.authenticated, body.authenticated { 
            display: block !important; 
            visibility: visible !important;
        }
        
        /* Loading screen khi đang check - luôn hiển thị cho đến khi authenticated */
        #auth-check {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }
        #auth-check.hidden {
            display: none !important;
        }
    </style>
    <link rel="stylesheet" href="css/admin.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Loading screen khi đang kiểm tra authentication -->
    <div id="auth-check">
        <div style="text-align: center;">
            <div style="font-size: 24px; margin-bottom: 20px;">Đang kiểm tra quyền truy cập...</div>
            <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        </div>
    </div>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-battery-full"></i>
                <span>EV Swap Admin</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li class="nav-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </li>
                <li class="nav-item" data-section="stations">
                    <i class="fas fa-charging-station"></i>
                    <span>Quản lý trạm</span>
                </li>
                <li class="nav-item" data-section="users">
                    <i class="fas fa-users"></i>
                    <span>Quản lý người dùng</span>
                </li>
                <li class="nav-item" data-section="packages">
                    <i class="fas fa-box"></i>
                    <span>Gói thuê</span>
                </li>
                <li class="nav-item" data-section="batteries">
                    <i class="fas fa-battery-full"></i>
                    <span>Quản lý pin</span>
                </li>
                <li class="nav-item" data-section="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Báo cáo</span>
                </li>
                <li class="nav-item" data-section="complaints">
                    <i class="fas fa-life-ring"></i>
                    <span>Xử lý khiếu nại</span>
                </li>
                <li class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Cài đặt</span>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <header class="top-bar">
            <div class="top-bar-left">
                <button class="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Dashboard</h1>
            </div>
            <div class="top-bar-right">
                <div class="notifications">
                    <button class="notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </button>
                </div>
                <div class="user-menu">
                    <div class="user-info">
                        <img src="https://via.placeholder.com/40" alt="Admin" class="user-avatar">
                        <span class="user-name">Admin User</span>
                    </div>
                    <div class="user-dropdown">
                        <button class="dropdown-toggle">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu">
                            <a href="#"><i class="fas fa-user"></i> Hồ sơ</a>
                            <a href="#"><i class="fas fa-cog"></i> Cài đặt</a>
                            <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="dashboard-grid">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-charging-station"></i>
                        </div>
                        <div class="stat-content">
                            <h3>25</h3>
                            <p>Tổng số trạm</p>
                            <span class="stat-change positive">+2 tháng này</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3>1,247</h3>
                            <p>Người dùng hoạt động</p>
                            <span class="stat-change positive">+15% so với tháng trước</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-battery-full"></i>
                        </div>
                        <div class="stat-content">
                            <h3>3,456</h3>
                            <p>Lượt đổi pin hôm nay</p>
                            <span class="stat-change positive">+8% so với hôm qua</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-content">
                            <h3>₫2.4M</h3>
                            <p>Doanh thu hôm nay</p>
                            <span class="stat-change positive">+12% so với hôm qua</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Lượt đổi pin theo thời gian</h3>
                            <div class="chart-controls">
                                <select class="chart-period">
                                    <option value="7">7 ngày</option>
                                    <option value="30" selected>30 ngày</option>
                                    <option value="90">90 ngày</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="swapsChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Trạng thái trạm</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="stationsStatusChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="activity-section">
                    <div class="section-header">
                        <h3>Hoạt động gần đây</h3>
                        <button class="btn btn-outline">Xem tất cả</button>
                    </div>
                    <div class="activity-list">
                        <div class="activity-item">
                            <div class="activity-icon success">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="activity-content">
                                <p><strong>Trạm Quận 1</strong> đã hoàn thành bảo trì</p>
                                <span class="activity-time">2 phút trước</span>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon warning">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="activity-content">
                                <p><strong>Trạm Quận 3</strong> cần thay thế pin</p>
                                <span class="activity-time">15 phút trước</span>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon info">
                                <i class="fas fa-info"></i>
                            </div>
                            <div class="activity-content">
                                <p><strong>Người dùng mới</strong> đăng ký gói tháng</p>
                                <span class="activity-time">1 giờ trước</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stations Management Section -->
        <section id="stations" class="content-section">
            <div class="section-header">
                <h2>Quản lý trạm</h2>
                <button class="btn btn-primary" onclick="showAddStationModal()">
                    <i class="fas fa-plus"></i> Thêm trạm mới
                </button>
            </div>
            
            <div class="stations-table-container">
                <div class="table-filters">
                    <div class="filter-group">
                        <label>Trạng thái:</label>
                        <select id="stationStatusFilter">
                            <option value="all">Tất cả</option>
                            <option value="active">Hoạt động</option>
                            <option value="maintenance">Bảo trì</option>
                            <option value="offline">Offline</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Tìm kiếm:</label>
                        <input type="text" id="stationSearch" placeholder="Tên trạm, địa chỉ...">
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="stations-table">
                        <thead>
                            <tr>
                                <th>Tên trạm</th>
                                <th>Địa chỉ</th>
                                <th>Trạng thái</th>
                                <th>Pin có sẵn</th>
                                <th>Đang sạc</th>
                                <th>Bảo trì</th>
                                <th>Đánh giá</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="stationsTableBody">
                            <!-- Stations data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Users Management Section -->
        <section id="users" class="content-section">
            <div class="section-header">
                <h2>Quản lý người dùng</h2>
                <div class="header-actions">
                    <button class="btn btn-outline">
                        <i class="fas fa-download"></i> Xuất Excel
                    </button>
                    <button class="btn btn-primary">
                        <i class="fas fa-plus"></i> Thêm người dùng
                    </button>
                </div>
            </div>
            
            <div class="users-stats">
                <div class="user-stat-card">
                    <h4>Tổng người dùng</h4>
                    <p class="stat-number">1,247</p>
                </div>
                <div class="user-stat-card">
                    <h4>Người dùng mới</h4>
                    <p class="stat-number">45</p>
                </div>
                <div class="user-stat-card">
                    <h4>Gói tháng</h4>
                    <p class="stat-number">892</p>
                </div>
                <div class="user-stat-card">
                    <h4>Gói năm</h4>
                    <p class="stat-number">156</p>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên</th>
                            <th>Email</th>
                            <th>Số điện thoại</th>
                            <th>Gói thuê</th>
                            <th>Lượt đổi</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Packages Management Section -->
        <section id="packages" class="content-section">
            <div class="section-header">
                <h2>Quản lý gói thuê</h2>
                <button class="btn btn-primary" onclick="showAddPackageModal()">
                    <i class="fas fa-plus"></i> Tạo gói mới
                </button>
            </div>
            
            <div class="packages-grid">
                <div class="package-card">
                    <div class="package-header">
                        <h3>Gói cơ bản</h3>
                        <div class="package-price">50,000đ/lần</div>
                    </div>
                    <div class="package-stats">
                        <div class="stat">
                            <span class="label">Người dùng:</span>
                            <span class="value">199</span>
                        </div>
                        <div class="stat">
                            <span class="label">Doanh thu:</span>
                            <span class="value">₫9.95M</span>
                        </div>
                    </div>
                    <div class="package-actions">
                        <button class="btn btn-outline">Chỉnh sửa</button>
                        <button class="btn btn-danger">Xóa</button>
                    </div>
                </div>
                
                <div class="package-card featured">
                    <div class="package-badge">Phổ biến</div>
                    <div class="package-header">
                        <h3>Gói tháng</h3>
                        <div class="package-price">800,000đ/tháng</div>
                    </div>
                    <div class="package-stats">
                        <div class="stat">
                            <span class="label">Người dùng:</span>
                            <span class="value">892</span>
                        </div>
                        <div class="stat">
                            <span class="label">Doanh thu:</span>
                            <span class="value">₫713.6M</span>
                        </div>
                    </div>
                    <div class="package-actions">
                        <button class="btn btn-outline">Chỉnh sửa</button>
                        <button class="btn btn-danger">Xóa</button>
                    </div>
                </div>
                
                <div class="package-card">
                    <div class="package-header">
                        <h3>Gói năm</h3>
                        <div class="package-price">8,000,000đ/năm</div>
                    </div>
                    <div class="package-stats">
                        <div class="stat">
                            <span class="label">Người dùng:</span>
                            <span class="value">156</span>
                        </div>
                        <div class="stat">
                            <span class="label">Doanh thu:</span>
                            <span class="value">₫1.25B</span>
                        </div>
                    </div>
                    <div class="package-actions">
                        <button class="btn btn-outline">Chỉnh sửa</button>
                        <button class="btn btn-danger">Xóa</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Batteries Management Section -->
        <section id="batteries" class="content-section">
            <div class="section-header">
                <h2>Quản lý pin</h2>
                    <div class="header-actions">
                    <button class="btn btn-primary" onclick="showBatteryCoordinationModal()" id="coordinationBtn" style="display: none;">
                        <i class="fas fa-exchange-alt"></i> Điều phối pin
                    </button>
                    <button class="btn btn-outline" onclick="loadStationsList()" id="backToStationsBtn" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Quay lại danh sách trạm
                    </button>
                </div>
            </div>
            
            <!-- Danh sách trạm -->
            <div id="stationsListSection" class="stations-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px;">
                <!-- Stations sẽ được load ở đây -->
            </div>
            
            <!-- Chi tiết pin của trạm -->
            <div id="batteriesDetailSection" style="display: none;">
            <div class="batteries-overview">
                <div class="overview-card">
                    <h4>Tổng quan pin</h4>
                    <div class="overview-stats">
                        <div class="overview-stat">
                            <span class="label">Tổng số pin:</span>
                            <span class="value">2,450</span>
                        </div>
                        <div class="overview-stat">
                            <span class="label">Đang sử dụng:</span>
                            <span class="value">1,234</span>
                        </div>
                        <div class="overview-stat">
                            <span class="label">Đang sạc:</span>
                            <span class="value">567</span>
                        </div>
                        <div class="overview-stat">
                            <span class="label">Bảo trì:</span>
                            <span class="value">89</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="batteries-table-container" style="margin-top: 20px;">
                <div class="table-filters">
                    <div class="filter-group">
                        <label>Trạng thái:</label>
                        <select id="batteryStatusFilter" onchange="filterBatteriesByStatus()">
                            <option value="all">Tất cả</option>
                            <option value="Pin đang sạc">Pin đang sạc</option>
                            <option value="Pin đầy">Pin đầy</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="batteries-table">
                        <thead>
                            <tr>
                                <th onclick="sortBatteries('idpin')" style="cursor: pointer; user-select: none;">
                                    ID Pin <i class="fas fa-sort" id="sort-idpin"></i>
                                </th>
                                <th onclick="sortBatteries('loaipin')" style="cursor: pointer; user-select: none;">
                                    Loại pin <i class="fas fa-sort" id="sort-loaipin"></i>
                                </th>
                                <th onclick="sortBatteries('dienap')" style="cursor: pointer; user-select: none;">
                                    Điện áp <i class="fas fa-sort" id="sort-dienap"></i>
                                </th>
                                <th onclick="sortBatteries('congsuat')" style="cursor: pointer; user-select: none;">
                                    Công suất <i class="fas fa-sort" id="sort-congsuat"></i>
                                </th>
                                <th onclick="sortBatteries('giadoipin')" style="cursor: pointer; user-select: none;">
                                    Giá đổi pin <i class="fas fa-sort" id="sort-giadoipin"></i>
                                </th>
                                <th onclick="sortBatteries('soh')" style="cursor: pointer; user-select: none;">
                                    SoH (%) <i class="fas fa-sort" id="sort-soh"></i>
                                </th>
                                <th onclick="sortBatteries('soc')" style="cursor: pointer; user-select: none;">
                                    SoC (%) <i class="fas fa-sort" id="sort-soc"></i>
                                </th>
                                <th onclick="sortBatteries('tinhtrang')" style="cursor: pointer; user-select: none;">
                                    Trạng thái <i class="fas fa-sort" id="sort-tinhtrang"></i>
                                </th>
                                <th>Cập nhật tình trạng</th>
                            </tr>
                        </thead>
                        <tbody id="batteriesTableBody">
                            <!-- Batteries data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="content-section">
            <div class="section-header">
                <h2>Báo cáo & Thống kê</h2>
                <div class="header-actions">
                    <button class="btn btn-outline">
                        <i class="fas fa-download"></i> Xuất PDF
                    </button>
                    <button class="btn btn-outline">
                        <i class="fas fa-file-excel"></i> Xuất Excel
                    </button>
                </div>
            </div>
            
            <div class="reports-filters">
                <div class="filter-group">
                    <label>Thời gian:</label>
                    <select id="reportPeriod">
                        <option value="today">Hôm nay</option>
                        <option value="week">Tuần này</option>
                        <option value="month" selected>Tháng này</option>
                        <option value="quarter">Quý này</option>
                        <option value="year">Năm này</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Từ ngày:</label>
                    <input type="date" id="startDate">
                </div>
                <div class="filter-group">
                    <label>Đến ngày:</label>
                    <input type="date" id="endDate">
                </div>
                <button class="btn btn-primary" onclick="generateReport()">
                    <i class="fas fa-chart-line"></i> Tạo báo cáo
                </button>
            </div>
            
            <div class="reports-grid">
                <div class="report-card">
                    <h4>Doanh thu</h4>
                    <div class="report-chart">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4>Lượt đổi pin</h4>
                    <div class="report-chart">
                        <canvas id="swapsReportChart"></canvas>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4>Giờ cao điểm</h4>
                    <div class="report-chart">
                        <canvas id="peakHoursChart"></canvas>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4>Dự báo nhu cầu (AI)</h4>
                    <div class="ai-prediction">
                        <div class="prediction-item">
                            <span class="prediction-label">Dự báo tuần tới:</span>
                            <span class="prediction-value">+15%</span>
                        </div>
                        <div class="prediction-item">
                            <span class="prediction-label">Trạm cần mở rộng:</span>
                            <span class="prediction-value">Quận 7, Quận 9</span>
                        </div>
                        <div class="prediction-item">
                            <span class="prediction-label">Khuyến nghị:</span>
                            <span class="prediction-value">Tăng 20% pin tại trạm trung tâm</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Complaints Management Section -->
        <section id="complaints" class="content-section">
            <div class="section-header">
                <h2>Xử lý khiếu nại</h2>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="refreshComplaints()">
                        <i class="fas fa-sync-alt"></i> Làm mới
                    </button>
                </div>
            </div>
            
            <div class="table-filters" style="margin-bottom: 20px;">
                <div class="filter-group">
                    <label>Lọc theo trạng thái:</label>
                    <select id="complaintStatusFilter" onchange="filterComplaints()">
                        <option value="">Tất cả</option>
                        <option value="Chờ xử lý">Chờ xử lý</option>
                        <option value="Đang xử lý">Đang xử lý</option>
                        <option value="Đã xử lý">Đã xử lý</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Tìm kiếm:</label>
                    <input type="text" id="complaintSearch" placeholder="Tìm theo ID, tên khách hàng..." onkeyup="filterComplaints()">
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Khách hàng</th>
                            <th>Email</th>
                            <th>Số điện thoại</th>
                            <th>Mô tả</th>
                            <th>Độ ưu tiên</th>
                            <th>Trạng thái</th>
                            <th>Ngày tạo</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="complaintsTableBody">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <i class="fas fa-spinner fa-spin"></i> Đang tải...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination" id="complaintsPagination" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                <!-- Pagination sẽ được thêm bởi JavaScript -->
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="content-section">
            <div class="section-header">
                <h2>Cài đặt hệ thống</h2>
            </div>
            
            <div class="settings-grid">
                <div class="settings-card">
                    <h4>Cài đặt chung</h4>
                    <form class="settings-form">
                        <div class="form-group">
                            <label>Tên hệ thống:</label>
                            <input type="text" value="EV Battery Swap System">
                        </div>
                        <div class="form-group">
                            <label>Email hỗ trợ:</label>
                            <input type="email" value="support@evswap.vn">
                        </div>
                        <div class="form-group">
                            <label>Số điện thoại:</label>
                            <input type="tel" value="1900-1234">
                        </div>
                        <button type="submit" class="btn btn-primary">Lưu cài đặt</button>
                    </form>
                </div>
                
                <div class="settings-card">
                    <h4>Cài đặt thông báo</h4>
                    <form class="settings-form">
                        <div class="form-group">
                            <label class="checkbox">
                                <input type="checkbox" checked>
                                <span>Thông báo trạm offline</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox">
                                <input type="checkbox" checked>
                                <span>Thông báo pin cần bảo trì</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox">
                                <input type="checkbox">
                                <span>Thông báo doanh thu hàng ngày</span>
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">Lưu cài đặt</button>
                    </form>
                </div>
                
                <div class="settings-card">
                    <h4>Bảo mật</h4>
                    <form class="settings-form">
                        <div class="form-group">
                            <label>Mật khẩu hiện tại:</label>
                            <input type="password">
                        </div>
                        <div class="form-group">
                            <label>Mật khẩu mới:</label>
                            <input type="password">
                        </div>
                        <div class="form-group">
                            <label>Xác nhận mật khẩu:</label>
                            <input type="password">
                        </div>
                        <button type="submit" class="btn btn-primary">Đổi mật khẩu</button>
                    </form>
                </div>
            </div>
        </section>
    </div>

    <!-- Add Station Modal -->
    <div id="addStationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Thêm trạm mới</h2>
                <span class="close" onclick="closeModal('addStationModal')">&times;</span>
            </div>
            <form class="modal-form">
                <div class="form-group">
                    <label for="stationName">Tên trạm:</label>
                    <input type="text" id="stationName" required>
                </div>
                <div class="form-group">
                    <label for="stationAddress">Địa chỉ:</label>
                    <input type="text" id="stationAddress" required>
                </div>
                <div class="form-group">
                    <label for="stationPhone">Số điện thoại:</label>
                    <input type="tel" id="stationPhone" required>
                </div>
                <div class="form-group">
                    <label for="stationCapacity">Số lượng pin tối đa:</label>
                    <input type="number" id="stationCapacity" required>
                </div>
                <div class="form-group">
                    <label for="stationManager">Người quản lý:</label>
                    <input type="text" id="stationManager" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addStationModal')">Hủy</button>
                    <button type="submit" class="btn btn-primary">Thêm trạm</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Package Modal -->
    <div id="addPackageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tạo gói thuê mới</h2>
                <span class="close" onclick="closeModal('addPackageModal')">&times;</span>
            </div>
            <form class="modal-form">
                <div class="form-group">
                    <label for="packageName">Tên gói:</label>
                    <input type="text" id="packageName" required>
                </div>
                <div class="form-group">
                    <label for="packagePrice">Giá:</label>
                    <input type="number" id="packagePrice" required>
                </div>
                <div class="form-group">
                    <label for="packageType">Loại gói:</label>
                    <select id="packageType" required>
                        <option value="per_swap">Theo lượt</option>
                        <option value="monthly">Hàng tháng</option>
                        <option value="yearly">Hàng năm</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="packageFeatures">Tính năng:</label>
                    <textarea id="packageFeatures" rows="4"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addPackageModal')">Hủy</button>
                    <button type="submit" class="btn btn-primary">Tạo gói</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Update Battery Status Modal -->
    <div id="updateBatteryStatusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cập nhật tình trạng pin</h2>
                <span class="close" onclick="closeModal('updateBatteryStatusModal')">&times;</span>
            </div>
            <form class="modal-form" id="updateBatteryStatusForm" onsubmit="handleUpdateBatteryStatus(event); return false;">
                <input type="hidden" id="updateBatteryId">
                <div class="form-group">
                    <label for="updateBatteryStatus">Tình trạng:</label>
                    <select id="updateBatteryStatus" required>
                        <option value="Pin đầy">Pin đầy</option>
                        <option value="Pin đang sạc">Pin đang sạc</option>
                    </select>
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Chọn tình trạng mới cho pin</small>
                </div>
                <div class="form-group">
                    <label for="updateBatterySoH">SoH (State of Health) %:</label>
                    <input type="number" id="updateBatterySoH" min="0" max="100" step="0.1">
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Tình trạng sức khỏe pin (0-100%)</small>
                </div>
                <div class="form-group">
                    <label for="updateBatterySoC">SoC (State of Charge) %:</label>
                    <input type="number" id="updateBatterySoC" min="0" max="100" step="0.1">
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Mức pin hiện tại (0-100%)</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('updateBatteryStatusModal')">Hủy</button>
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Complaint Detail Modal -->
    <div id="complaintDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-life-ring"></i> Chi tiết khiếu nại #<span id="complaintDetailId"></span></h2>
                <span class="close" onclick="closeModal('complaintDetailModal')">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 25px;">
                <!-- Thông tin khách hàng -->
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #e2e8f0;">
                    <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 18px;">
                        <i class="fas fa-user"></i> Thông tin khách hàng
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div>
                            <label style="color: #64748b; font-size: 13px; font-weight: 500;">Tên:</label>
                            <p style="margin: 5px 0 0 0; color: #1e293b; font-weight: 500;" id="complaintCustomerName">--</p>
                        </div>
                        <div>
                            <label style="color: #64748b; font-size: 13px; font-weight: 500;">Email:</label>
                            <p style="margin: 5px 0 0 0; color: #1e293b; font-weight: 500;" id="complaintCustomerEmail">--</p>
                        </div>
                        <div>
                            <label style="color: #64748b; font-size: 13px; font-weight: 500;">Số điện thoại:</label>
                            <p style="margin: 5px 0 0 0; color: #1e293b; font-weight: 500;" id="complaintCustomerPhone">--</p>
                        </div>
                        <div>
                            <label style="color: #64748b; font-size: 13px; font-weight: 500;">Tuổi:</label>
                            <p style="margin: 5px 0 0 0; color: #1e293b; font-weight: 500;" id="complaintCustomerAge">--</p>
                        </div>
                    </div>
                </div>
                
                <!-- Thông tin khiếu nại -->
                <div style="margin-bottom: 25px;">
                    <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 18px; display: flex; align-items: center;">
                        <i class="fas fa-info-circle" style="margin-right: 10px; color: #3b82f6;"></i> Thông tin khiếu nại
                    </h3>
                    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="color: #64748b; font-size: 13px; font-weight: 500;">Trạng thái:</label>
                                <p style="margin: 5px 0 0 0;" id="complaintDetailStatus">--</p>
                            </div>
                            <div>
                                <label style="color: #64748b; font-size: 13px; font-weight: 500;">Độ ưu tiên:</label>
                                <p style="margin: 5px 0 0 0;" id="complaintDetailPriority">--</p>
                            </div>
                            <div>
                                <label style="color: #64748b; font-size: 13px; font-weight: 500;">Ngày tạo:</label>
                                <p style="margin: 5px 0 0 0; color: #1e293b;" id="complaintDetailDate">--</p>
                            </div>
                            <div>
                                <label style="color: #64748b; font-size: 13px; font-weight: 500;">Ngày xử lý:</label>
                                <p style="margin: 5px 0 0 0; color: #1e293b;" id="complaintDetailProcessedDate">--</p>
                            </div>
                        </div>
                        <div>
                            <label style="color: #64748b; font-size: 13px; font-weight: 500;">Mô tả:</label>
                            <p style="margin: 5px 0 0 0; color: #1e293b; white-space: pre-wrap; line-height: 1.6;" id="complaintDetailDescription">--</p>
                        </div>
                    </div>
                </div>
                
                <!-- Lịch sử tin nhắn -->
                <div style="margin-bottom: 25px;" id="complaintMessagesSection">
                    <h3 style="margin: 0 0 18px 0; color: #1e293b; font-size: 18px; display: flex; align-items: center; font-weight: 600;">
                        <i class="fas fa-comments" style="margin-right: 10px; color: #3b82f6;"></i> Lịch sử trò chuyện
                    </h3>
                    <div id="complaintMessagesList" style="max-height: 400px; overflow-y: auto; background: #f8fafc; border-radius: 12px; padding: 25px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <p style="text-align: center; color: #64748b; padding: 20px;">Đang tải tin nhắn...</p>
                    </div>
                </div>
                
                <!-- Form trả lời -->
                <div style="background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 25px; margin-top: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h3 style="margin: 0 0 20px 0; color: #1e293b; font-size: 18px; display: flex; align-items: center; font-weight: 600;">
                        <i class="fas fa-edit" style="margin-right: 10px; color: #3b82f6;"></i> Trả lời khiếu nại
                    </h3>
                    <form id="complaintResponseForm" onsubmit="handleComplaintResponse(event); return false;">
                        <input type="hidden" id="complaintResponseId">
                        <div class="form-group" style="margin-bottom: 18px;">
                            <label for="complaintResponseText" style="display: block; margin-bottom: 8px; color: #475569; font-weight: 500; font-size: 14px;">Nội dung phản hồi *</label>
                            <textarea id="complaintResponseText" rows="5" required 
                                      placeholder="Nhập nội dung phản hồi cho khách hàng..." 
                                      style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; font-family: inherit; resize: vertical; transition: border-color 0.3s;"
                                      onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
                                      onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';"></textarea>
                        </div>
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="complaintResponseStatus" style="display: block; margin-bottom: 8px; color: #475569; font-weight: 500; font-size: 14px;">Cập nhật trạng thái:</label>
                            <select id="complaintResponseStatus" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; background: white; cursor: pointer; transition: border-color 0.3s;"
                                    onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
                                    onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
                                <option value="Chờ xử lý">Chờ xử lý</option>
                                <option value="Đang xử lý">Đang xử lý</option>
                                <option value="Đã xử lý">Đã xử lý</option>
                            </select>
                        </div>
                        <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                            <button type="button" class="btn btn-outline" onclick="closeModal('complaintDetailModal')" style="padding: 10px 20px;">Đóng</button>
                            <button type="submit" class="btn btn-primary" style="padding: 10px 24px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-paper-plane"></i> Gửi phản hồi
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Battery Coordination Modal -->
    <div id="batteryCoordinationModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Điều phối pin giữa các trạm</h2>
                <span class="close" onclick="closeModal('batteryCoordinationModal')">&times;</span>
            </div>
            <form class="modal-form" id="batteryCoordinationForm" onsubmit="handleBatteryCoordination(event); return false;">
                <div class="form-group">
                    <label for="fromStationSelect">Trạm nguồn:</label>
                    <select id="fromStationSelect" required onchange="loadStationBatteries('from')">
                        <option value="">-- Chọn trạm nguồn --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="toStationSelect">Trạm đích:</label>
                    <select id="toStationSelect" required>
                        <option value="">-- Chọn trạm đích --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Chọn pin cần chuyển (từ trạm nguồn):</label>
                    <div id="availableBatteriesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-top: 10px;">
                        <p style="color: #6b7280; text-align: center; padding: 20px;">Vui lòng chọn trạm nguồn để xem danh sách pin</p>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('batteryCoordinationModal')">Hủy</button>
                    <button type="submit" class="btn btn-primary">Xác nhận điều phối</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/admin.js"></script>
</body>
</html>