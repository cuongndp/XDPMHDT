<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - EV Battery Swap System</title>
    <script>
        // Kiểm tra authentication NGAY LẬP TỨC - trước khi load bất kỳ thứ gì
        (function() {
            // Block toàn bộ HTML ngay lập tức
            if (document.documentElement) {
                document.documentElement.style.display = 'none';
            }
            if (document.body) {
                document.body.style.display = 'none';
            }
            
            // Kiểm tra token
            const adminToken = localStorage.getItem('adminToken');
            if (!adminToken || adminToken.trim() === '') {
                // Redirect NGAY - không cho xem bất kỳ nội dung nào
                window.location.replace('admin-login.html');
                // Force redirect nếu replace không work
                setTimeout(function() {
                    window.location.href = 'admin-login.html';
                }, 100);
                return;
            }
            
            // Nếu có token, cho phép hiển thị (sẽ được admin.js kiểm tra lại)
            if (document.documentElement) {
                document.documentElement.style.display = '';
            }
        })();
    </script>
    <style>
        /* Ẩn toàn bộ trang cho đến khi đã xác thực */
        html, body { 
            display: none !important; 
            visibility: hidden !important;
        }
        html.authenticated, body.authenticated { 
            display: block !important; 
            visibility: visible !important;
        }
        
        /* Loading screen khi đang check - luôn hiển thị cho đến khi authenticated */
        #auth-check {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }
        #auth-check.hidden {
            display: none !important;
        }
    </style>
    <link rel="stylesheet" href="css/admin.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Loading screen khi đang kiểm tra authentication -->
    <div id="auth-check">
        <div style="text-align: center;">
            <div style="font-size: 24px; margin-bottom: 20px;">Đang kiểm tra quyền truy cập...</div>
            <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        </div>
    </div>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-battery-full"></i>
                <span>EV Swap Admin</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li class="nav-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </li>
                <li class="nav-item" data-section="users">
                    <i class="fas fa-users"></i>
                    <span>Quản lý người dùng</span>
                </li>
                <li class="nav-item" data-section="packages">
                    <i class="fas fa-box"></i>
                    <span>Gói thuê</span>
                </li>
                <li class="nav-item" data-section="batteries">
                    <i class="fas fa-battery-full"></i>
                    <span>Quản lý pin</span>
                </li>
                <li class="nav-item" data-section="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Báo cáo</span>
                </li>
                <li class="nav-item" data-section="complaints">
                    <i class="fas fa-life-ring"></i>
                    <span>Xử lý khiếu nại</span>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <header class="top-bar">
            <div class="top-bar-left">
                <button class="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Dashboard</h1>
            </div>
            <div class="top-bar-right">
                <button class="btn btn-outline" onclick="logout()" style="margin-left: auto;">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </div>
        </header>

        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="dashboard-grid">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-charging-station"></i>
                        </div>
                        <div class="stat-content">
                            <h3>25</h3>
                            <p>Tổng số trạm</p>
                            <span class="stat-change positive">+2 tháng này</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3>1,247</h3>
                            <p>Người dùng hoạt động</p>
                            <span class="stat-change positive">+15% so với tháng trước</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-battery-full"></i>
                        </div>
                        <div class="stat-content">
                            <h3>3,456</h3>
                            <p>Lượt đổi pin hôm nay</p>
                            <span class="stat-change positive">+8% so với hôm qua</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-content">
                            <h3>₫2.4M</h3>
                            <p>Doanh thu hôm nay</p>
                            <span class="stat-change positive">+12% so với hôm qua</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Lượt đổi pin theo thời gian</h3>
                            <div class="chart-controls">
                                <select class="chart-period">
                                    <option value="7">7 ngày</option>
                                    <option value="30" selected>30 ngày</option>
                                    <option value="90">90 ngày</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="swapsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Users Management Section -->
        <section id="users" class="content-section">
            <div class="section-header">
                <h2>Quản lý người dùng</h2>
                <div class="header-actions">
                    <button class="btn btn-outline">
                        <i class="fas fa-download"></i> Xuất Excel
                    </button>
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        <i class="fas fa-plus"></i> Thêm người dùng
                    </button>
                </div>
            </div>
            
            <!-- Tabs để phân loại driver và staff -->
            <div class="user-tabs">
                <button class="user-tab active" onclick="switchUserTab('driver')" id="tab-driver">
                    Người dùng (Driver)
                </button>
                <button class="user-tab" onclick="switchUserTab('staff')" id="tab-staff">
                    Nhân viên (Staff)
                </button>
            </div>
            
            <style>
                .user-tabs {
                    margin-bottom: 20px;
                    border-bottom: 2px solid #e2e8f0;
                    display: flex;
                    gap: 0;
                }
                .user-tab {
                    padding: 12px 24px;
                    background: none;
                    border: none;
                    border-bottom: 3px solid transparent;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                    color: #64748b;
                    transition: all 0.2s;
                }
                .user-tab:hover {
                    color: #1e293b;
                    background: #f1f5f9;
                }
                .user-tab.active {
                    color: #3b82f6;
                    border-bottom-color: #3b82f6;
                    font-weight: 600;
                }
            </style>
            
            <div class="users-stats" id="usersStats">
                <div class="user-stat-card">
                    <h4>Tổng người dùng</h4>
                    <p class="stat-number" id="totalUsers">0</p>
                </div>
                <div class="user-stat-card">
                    <h4>Người dùng mới</h4>
                    <p class="stat-number" id="newUsers">0</p>
                </div>
                <div class="user-stat-card">
                    <h4>Gói tháng</h4>
                    <p class="stat-number" id="monthlyPackages">0</p>
                </div>
                <div class="user-stat-card">
                    <h4>Gói năm</h4>
                    <p class="stat-number" id="yearlyPackages">0</p>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên</th>
                            <th>Email</th>
                            <th>Số điện thoại</th>
                            <th>Role</th>
                            <th class="goi-thue-column">Gói thuê</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #64748b;">
                                <i class="fas fa-spinner fa-spin"></i> Đang tải...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Packages Management Section -->
        <section id="packages" class="content-section">
            <div class="section-header">
                <h2>Quản lý gói thuê</h2>
                <button class="btn btn-primary" onclick="showAddPackageModal()">
                    <i class="fas fa-plus"></i> Tạo gói mới
                </button>
            </div>
            
            <div class="packages-grid" id="packagesGrid">
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <i class="fas fa-spinner fa-spin"></i> Đang tải...
                </div>
            </div>
        </section>

        <!-- Batteries Management Section -->
        <section id="batteries" class="content-section">
            <div class="section-header">
                <h2>Quản lý pin</h2>
                    <div class="header-actions">
                    <button class="btn btn-primary" onclick="showBatteryCoordinationModal()" id="coordinationBtn" style="display: none;">
                        <i class="fas fa-exchange-alt"></i> Điều phối pin
                    </button>
                    <button class="btn btn-outline" onclick="loadStationsList()" id="backToStationsBtn" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Quay lại danh sách trạm
                    </button>
                </div>
            </div>
            
            <!-- Danh sách trạm -->
            <div id="stationsListSection" class="stations-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px;">
                <!-- Stations sẽ được load ở đây -->
            </div>
            
            <!-- Chi tiết pin của trạm -->
            <div id="batteriesDetailSection" style="display: none;">
            <div class="batteries-overview">
                <div class="overview-card">
                    <h4>Tổng quan pin</h4>
                    <div class="overview-stats">
                        <div class="overview-stat">
                            <span class="label">Tổng số pin:</span>
                            <span class="value">2,450</span>
                        </div>
                        <div class="overview-stat">
                            <span class="label">Đang sử dụng:</span>
                            <span class="value">1,234</span>
                        </div>
                        <div class="overview-stat">
                            <span class="label">Đang sạc:</span>
                            <span class="value">567</span>
                        </div>
                        <div class="overview-stat">
                            <span class="label">Bảo trì:</span>
                            <span class="value">89</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="batteries-table-container" style="margin-top: 20px;">
                <div class="table-filters">
                    <div class="filter-group">
                        <label>Trạng thái:</label>
                        <select id="batteryStatusFilter" onchange="filterBatteriesByStatus()">
                            <option value="all">Tất cả</option>
                            <option value="Pin đang sạc">Pin đang sạc</option>
                            <option value="Pin đầy">Pin đầy</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="batteries-table">
                        <thead>
                            <tr>
                                <th onclick="sortBatteries('idpin')" style="cursor: pointer; user-select: none;">
                                    ID Pin <i class="fas fa-sort" id="sort-idpin"></i>
                                </th>
                                <th onclick="sortBatteries('loaipin')" style="cursor: pointer; user-select: none;">
                                    Loại pin <i class="fas fa-sort" id="sort-loaipin"></i>
                                </th>
                                <th onclick="sortBatteries('dienap')" style="cursor: pointer; user-select: none;">
                                    Điện áp <i class="fas fa-sort" id="sort-dienap"></i>
                                </th>
                                <th onclick="sortBatteries('congsuat')" style="cursor: pointer; user-select: none;">
                                    Công suất <i class="fas fa-sort" id="sort-congsuat"></i>
                                </th>
                                <th onclick="sortBatteries('giadoipin')" style="cursor: pointer; user-select: none;">
                                    Giá đổi pin <i class="fas fa-sort" id="sort-giadoipin"></i>
                                </th>
                                <th onclick="sortBatteries('soh')" style="cursor: pointer; user-select: none;">
                                    SoH (%) <i class="fas fa-sort" id="sort-soh"></i>
                                </th>
                                <th onclick="sortBatteries('soc')" style="cursor: pointer; user-select: none;">
                                    SoC (%) <i class="fas fa-sort" id="sort-soc"></i>
                                </th>
                                <th onclick="sortBatteries('tinhtrang')" style="cursor: pointer; user-select: none;">
                                    Trạng thái <i class="fas fa-sort" id="sort-tinhtrang"></i>
                                </th>
                                <th>Cập nhật tình trạng</th>
                            </tr>
                        </thead>
                        <tbody id="batteriesTableBody">
                            <!-- Batteries data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="content-section">
            <div class="section-header">
                <h2>Báo cáo & Thống kê</h2>
                <div class="header-actions">
                    <button class="btn btn-outline">
                        <i class="fas fa-download"></i> Xuất PDF
                    </button>
                    <button class="btn btn-outline">
                        <i class="fas fa-file-excel"></i> Xuất Excel
                    </button>
                </div>
            </div>
            
            <div class="reports-filters">
                <div class="filter-group">
                    <label>Thời gian:</label>
                    <select id="reportPeriod">
                        <option value="today">Hôm nay</option>
                        <option value="week">Tuần này</option>
                        <option value="month" selected>Tháng này</option>
                        <option value="quarter">Quý này</option>
                        <option value="year">Năm này</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Từ ngày:</label>
                    <input type="date" id="startDate">
                </div>
                <div class="filter-group">
                    <label>Đến ngày:</label>
                    <input type="date" id="endDate">
                </div>
                <button class="btn btn-primary" onclick="generateReport()">
                    <i class="fas fa-chart-line"></i> Tạo báo cáo
                </button>
            </div>
            
            <div class="reports-grid">
                <div class="report-card">
                    <h4>Doanh thu</h4>
                    <div class="report-chart">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4>Lượt đổi pin</h4>
                    <div class="report-chart">
                        <canvas id="swapsReportChart"></canvas>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4>Giờ cao điểm</h4>
                    <div class="report-chart">
                        <canvas id="peakHoursChart"></canvas>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4>Dự báo nhu cầu (AI)</h4>
                    <div class="ai-prediction">
                        <div class="prediction-item">
                            <span class="prediction-label">Dự báo tuần tới:</span>
                            <span class="prediction-value">+15%</span>
                        </div>
                        <div class="prediction-item">
                            <span class="prediction-label">Trạm cần mở rộng:</span>
                            <span class="prediction-value">Quận 7, Quận 9</span>
                        </div>
                        <div class="prediction-item">
                            <span class="prediction-label">Khuyến nghị:</span>
                            <span class="prediction-value">Tăng 20% pin tại trạm trung tâm</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Complaints Management Section -->
        <section id="complaints" class="content-section">
            <div class="section-header">
                <h2>Xử lý khiếu nại</h2>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="refreshComplaints()">
                        <i class="fas fa-sync-alt"></i> Làm mới
                    </button>
                </div>
            </div>
            
            <div class="table-filters" style="margin-bottom: 20px;">
                <div class="filter-group">
                    <label>Lọc theo trạng thái:</label>
                    <select id="complaintStatusFilter" onchange="filterComplaints()">
                        <option value="">Tất cả</option>
                        <option value="Chờ xử lý">Chờ xử lý</option>
                        <option value="Đang xử lý">Đang xử lý</option>
                        <option value="Đã xử lý">Đã xử lý</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Tìm kiếm:</label>
                    <input type="text" id="complaintSearch" placeholder="Tìm theo ID, tên khách hàng..." onkeyup="filterComplaints()">
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Khách hàng</th>
                            <th>Email</th>
                            <th>Số điện thoại</th>
                            <th>Mô tả</th>
                            <th>Độ ưu tiên</th>
                            <th>Trạng thái</th>
                            <th>Ngày tạo</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="complaintsTableBody">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <i class="fas fa-spinner fa-spin"></i> Đang tải...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination" id="complaintsPagination" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                <!-- Pagination sẽ được thêm bởi JavaScript -->
            </div>
        </section>

    </div>

    <!-- Add Package Modal -->
    <div id="addPackageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tạo gói thuê mới</h2>
                <span class="close" onclick="closeModal('addPackageModal')">&times;</span>
            </div>
            <form class="modal-form" id="addPackageForm" onsubmit="handleCreatePackage(event); return false;">
                <div class="form-group">
                    <label for="packageName">Tên gói dịch vụ:</label>
                    <input type="text" id="packageName" name="tendichvu" required>
                </div>
                <div class="form-group">
                    <label for="packageMota">Mô tả:</label>
                    <textarea id="packageMota" name="mota" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="packageThoihan">Thời hạn (tháng):</label>
                    <input type="number" id="packageThoihan" name="thoihan" min="0" placeholder="0 = không giới hạn">
                </div>
                <div class="form-group">
                    <label for="packagePrice">Phí (VNĐ):</label>
                    <input type="number" id="packagePrice" name="phi" min="0" required>
                </div>
                <div class="form-group">
                    <label for="packageSolandoipin">Số lần đổi pin:</label>
                    <input type="text" id="packageSolandoipin" name="solandoipin" placeholder="không giới hạn, hoặc số cụ thể">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addPackageModal')">Hủy</button>
                    <button type="submit" class="btn btn-primary">Tạo gói</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Package Modal -->
    <div id="editPackageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chỉnh sửa gói thuê</h2>
                <span class="close" onclick="closeModal('editPackageModal')">&times;</span>
            </div>
            <form class="modal-form" id="editPackageForm" onsubmit="handleUpdatePackage(event); return false;">
                <input type="hidden" id="editPackageId">
                <div class="form-group">
                    <label for="editPackageName">Tên gói dịch vụ:</label>
                    <input type="text" id="editPackageName" name="tendichvu" required>
                </div>
                <div class="form-group">
                    <label for="editPackageMota">Mô tả:</label>
                    <textarea id="editPackageMota" name="mota" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editPackageThoihan">Thời hạn (tháng):</label>
                    <input type="number" id="editPackageThoihan" name="thoihan" min="0" placeholder="0 = không giới hạn">
                </div>
                <div class="form-group">
                    <label for="editPackagePrice">Phí (VNĐ):</label>
                    <input type="number" id="editPackagePrice" name="phi" min="0" required>
                </div>
                <div class="form-group">
                    <label for="editPackageSolandoipin">Số lần đổi pin:</label>
                    <input type="text" id="editPackageSolandoipin" name="solandoipin" placeholder="không giới hạn, hoặc số cụ thể">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('editPackageModal')">Hủy</button>
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Thêm người dùng mới</h2>
                <span class="close" onclick="closeModal('addUserModal')">&times;</span>
            </div>
            <form class="modal-form" id="addUserForm" onsubmit="handleCreateUser(event); return false;">
                <div class="form-group">
                    <label for="userName">Tên:</label>
                    <input type="text" id="userName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">Email:</label>
                    <input type="email" id="userEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="userPassword">Mật khẩu:</label>
                    <input type="password" id="userPassword" name="password" required>
                </div>
                <div class="form-group">
                    <label for="userRole">Vai trò:</label>
                    <select id="userRole" name="role" required>
                        <option value="driver">Người dùng (Driver)</option>
                        <option value="staff">Nhân viên (Staff)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userPhone">Số điện thoại:</label>
                    <input type="text" id="userPhone" name="sodienthoai">
                </div>
                <div class="form-group">
                    <label for="userAge">Tuổi:</label>
                    <input type="number" id="userAge" name="age" min="0">
                </div>
                <div class="form-group">
                    <label for="userGender">Giới tính:</label>
                    <select id="userGender" name="gioitinh">
                        <option value="">-- Chọn --</option>
                        <option value="Nam">Nam</option>
                        <option value="Nữ">Nữ</option>
                        <option value="Khác">Khác</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addUserModal')">Hủy</button>
                    <button type="submit" class="btn btn-primary">Tạo người dùng</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chỉnh sửa người dùng</h2>
                <span class="close" onclick="closeModal('editUserModal')">&times;</span>
            </div>
            <form class="modal-form" id="editUserForm" onsubmit="handleUpdateUser(event); return false;">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label for="editUserName">Tên:</label>
                    <input type="text" id="editUserName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="editUserEmail">Email:</label>
                    <input type="email" id="editUserEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="editUserPassword">Mật khẩu mới (để trống nếu không đổi):</label>
                    <input type="password" id="editUserPassword" name="password">
                </div>
                <div class="form-group">
                    <label for="editUserRole">Vai trò:</label>
                    <select id="editUserRole" name="role" required>
                        <option value="driver">Người dùng (Driver)</option>
                        <option value="staff">Nhân viên (Staff)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editUserPhone">Số điện thoại:</label>
                    <input type="text" id="editUserPhone" name="sodienthoai">
                </div>
                <div class="form-group">
                    <label for="editUserAge">Tuổi:</label>
                    <input type="number" id="editUserAge" name="age" min="0">
                </div>
                <div class="form-group">
                    <label for="editUserGender">Giới tính:</label>
                    <select id="editUserGender" name="gioitinh">
                        <option value="">-- Chọn --</option>
                        <option value="Nam">Nam</option>
                        <option value="Nữ">Nữ</option>
                        <option value="Khác">Khác</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('editUserModal')">Hủy</button>
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Update Battery Status Modal -->
    <div id="updateBatteryStatusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cập nhật tình trạng pin</h2>
                <span class="close" onclick="closeModal('updateBatteryStatusModal')">&times;</span>
            </div>
            <form class="modal-form" id="updateBatteryStatusForm" onsubmit="handleUpdateBatteryStatus(event); return false;">
                <input type="hidden" id="updateBatteryId">
                <div class="form-group">
                    <label for="updateBatteryStatus">Tình trạng:</label>
                    <select id="updateBatteryStatus" required>
                        <option value="Pin đầy">Pin đầy</option>
                        <option value="Pin đang sạc">Pin đang sạc</option>
                    </select>
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Chọn tình trạng mới cho pin</small>
                </div>
                <div class="form-group">
                    <label for="updateBatterySoH">SoH (State of Health) %:</label>
                    <input type="number" id="updateBatterySoH" min="0" max="100" step="0.1">
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Tình trạng sức khỏe pin (0-100%)</small>
                </div>
                <div class="form-group">
                    <label for="updateBatterySoC">SoC (State of Charge) %:</label>
                    <input type="number" id="updateBatterySoC" min="0" max="100" step="0.1">
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Mức pin hiện tại (0-100%)</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('updateBatteryStatusModal')">Hủy</button>
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Complaint Detail Modal -->
    <div id="complaintDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-life-ring"></i> Chi tiết khiếu nại #<span id="complaintDetailId"></span></h2>
                <span class="close" onclick="closeModal('complaintDetailModal')">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 25px;">
                <!-- Thông tin khách hàng -->
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #e2e8f0;">
                    <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 18px;">
                        <i class="fas fa-user"></i> Thông tin khách hàng
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div>
                            <label style="color: #64748b; font-size: 13px; font-weight: 500;">Tên:</label>
                            <p style="margin: 5px 0 0 0; color: #1e293b; font-weight: 500;" id="complaintCustomerName">--</p>
                        </div>
                        <div>
                            <label style="color: #64748b; font-size: 13px; font-weight: 500;">Email:</label>
                            <p style="margin: 5px 0 0 0; color: #1e293b; font-weight: 500;" id="complaintCustomerEmail">--</p>
                        </div>
                        <div>
                            <label style="color: #64748b; font-size: 13px; font-weight: 500;">Số điện thoại:</label>
                            <p style="margin: 5px 0 0 0; color: #1e293b; font-weight: 500;" id="complaintCustomerPhone">--</p>
                        </div>
                        <div>
                            <label style="color: #64748b; font-size: 13px; font-weight: 500;">Tuổi:</label>
                            <p style="margin: 5px 0 0 0; color: #1e293b; font-weight: 500;" id="complaintCustomerAge">--</p>
                        </div>
                    </div>
                </div>
                
                <!-- Thông tin khiếu nại -->
                <div style="margin-bottom: 25px;">
                    <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 18px; display: flex; align-items: center;">
                        <i class="fas fa-info-circle" style="margin-right: 10px; color: #3b82f6;"></i> Thông tin khiếu nại
                    </h3>
                    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="color: #64748b; font-size: 13px; font-weight: 500;">Trạng thái:</label>
                                <p style="margin: 5px 0 0 0;" id="complaintDetailStatus">--</p>
                            </div>
                            <div>
                                <label style="color: #64748b; font-size: 13px; font-weight: 500;">Độ ưu tiên:</label>
                                <p style="margin: 5px 0 0 0;" id="complaintDetailPriority">--</p>
                            </div>
                            <div>
                                <label style="color: #64748b; font-size: 13px; font-weight: 500;">Ngày tạo:</label>
                                <p style="margin: 5px 0 0 0; color: #1e293b;" id="complaintDetailDate">--</p>
                            </div>
                            <div>
                                <label style="color: #64748b; font-size: 13px; font-weight: 500;">Ngày xử lý:</label>
                                <p style="margin: 5px 0 0 0; color: #1e293b;" id="complaintDetailProcessedDate">--</p>
                            </div>
                        </div>
                        <div>
                            <label style="color: #64748b; font-size: 13px; font-weight: 500;">Mô tả:</label>
                            <p style="margin: 5px 0 0 0; color: #1e293b; white-space: pre-wrap; line-height: 1.6;" id="complaintDetailDescription">--</p>
                        </div>
                    </div>
                </div>
                
                <!-- Lịch sử tin nhắn -->
                <div style="margin-bottom: 25px;" id="complaintMessagesSection">
                    <h3 style="margin: 0 0 18px 0; color: #1e293b; font-size: 18px; display: flex; align-items: center; font-weight: 600;">
                        <i class="fas fa-comments" style="margin-right: 10px; color: #3b82f6;"></i> Lịch sử trò chuyện
                    </h3>
                    <div id="complaintMessagesList" style="max-height: 400px; overflow-y: auto; background: #f8fafc; border-radius: 12px; padding: 25px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <p style="text-align: center; color: #64748b; padding: 20px;">Đang tải tin nhắn...</p>
                    </div>
                </div>
                
                <!-- Form trả lời -->
                <div style="background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 25px; margin-top: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h3 style="margin: 0 0 20px 0; color: #1e293b; font-size: 18px; display: flex; align-items: center; font-weight: 600;">
                        <i class="fas fa-edit" style="margin-right: 10px; color: #3b82f6;"></i> Trả lời khiếu nại
                    </h3>
                    <form id="complaintResponseForm" onsubmit="handleComplaintResponse(event); return false;">
                        <input type="hidden" id="complaintResponseId">
                        <div class="form-group" style="margin-bottom: 18px;">
                            <label for="complaintResponseText" style="display: block; margin-bottom: 8px; color: #475569; font-weight: 500; font-size: 14px;">Nội dung phản hồi *</label>
                            <textarea id="complaintResponseText" rows="5" required 
                                      placeholder="Nhập nội dung phản hồi cho khách hàng..." 
                                      style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; font-family: inherit; resize: vertical; transition: border-color 0.3s;"
                                      onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
                                      onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';"></textarea>
                        </div>
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="complaintResponseStatus" style="display: block; margin-bottom: 8px; color: #475569; font-weight: 500; font-size: 14px;">Cập nhật trạng thái:</label>
                            <select id="complaintResponseStatus" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; background: white; cursor: pointer; transition: border-color 0.3s;"
                                    onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
                                    onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
                                <option value="Chờ xử lý">Chờ xử lý</option>
                                <option value="Đang xử lý">Đang xử lý</option>
                                <option value="Đã xử lý">Đã xử lý</option>
                            </select>
                        </div>
                        <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                            <button type="button" class="btn btn-outline" onclick="closeModal('complaintDetailModal')" style="padding: 10px 20px;">Đóng</button>
                            <button type="submit" class="btn btn-primary" style="padding: 10px 24px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-paper-plane"></i> Gửi phản hồi
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Battery Coordination Modal -->
    <div id="batteryCoordinationModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Điều phối pin giữa các trạm</h2>
                <span class="close" onclick="closeModal('batteryCoordinationModal')">&times;</span>
            </div>
            <form class="modal-form" id="batteryCoordinationForm" onsubmit="handleBatteryCoordination(event); return false;">
                <div class="form-group">
                    <label for="fromStationSelect">Trạm nguồn:</label>
                    <select id="fromStationSelect" required onchange="loadStationBatteries('from')">
                        <option value="">-- Chọn trạm nguồn --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="toStationSelect">Trạm đích:</label>
                    <select id="toStationSelect" required>
                        <option value="">-- Chọn trạm đích --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Chọn pin cần chuyển (từ trạm nguồn):</label>
                    <div id="availableBatteriesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-top: 10px;">
                        <p style="color: #6b7280; text-align: center; padding: 20px;">Vui lòng chọn trạm nguồn để xem danh sách pin</p>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('batteryCoordinationModal')">Hủy</button>
                    <button type="submit" class="btn btn-primary">Xác nhận điều phối</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/admin.js"></script>
</body>
</html>